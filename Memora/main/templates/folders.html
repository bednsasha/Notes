{% load static %}
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memora</title>
    <link href="{% static 'Bootstrap/bootstrap.min.css' %}" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'font/Manrope/stylesheet.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <script src="{% static 'Bootstrap/bootstrap.bundle.min.js' %}" crossorigin="anonymous"></script>

</head>



<body class="background">
    <header>
        <div class="heder-all">
            <img src="{% static 'img/logo_header.svg' %}" alt="Logo_header" class="logo_header">
            <div class="container">
                 <div class="button-all">
                     
                    {% for m in menu %}
            
                    {% if 'Папки' in m.title  %}
      
                    <a href="{% url m.url_name  %}">
                        <button class="activе-bt">{{m.title}} </button>
                    </a>
                   
                    {% else %}

                    <a href="{% url m.url_name  %}">
                    <button class="my-btn" href="{% url m.url_name %}">{{m.title}}</button>

                    </a>
                    {% endif %}
                    {% endfor %}
                </div> 

            </div>
             <div class="account-all">

  {% if user.is_authenticated %}
    <div style="display: inline-flex; align-items: center; gap: 8px;">
        <span style="padding-left: 5px;">{{ user.username }}</span>
        <span style="border-left: 1px solid #ccc; height: 16px;"></span> <!-- Разграничитель -->
        <a href="#" id="logout-link" style="padding-left: 5px; margin-right: 10px;">Выйти</a>
    </div>

    <form id="logout-form" method="post" action="{% url 'users:logout' %}" style="display: none;">
        {% csrf_token %}
    </form>

    <img src="{% static 'img/akk.svg' %}" alt="account" class="account">
{% else %}

    <div style="display: inline-flex; align-items: center;">
        <a href="{% url 'users:login' %}" class="login-link" >Войти</a>
        <img src="{% static 'img/akk.svg' %}" alt="account" class="account with-margin">
    </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('logout-form').submit();
            });
        }
    });
</script>


        </div>
    </header>

    <section style="margin-top: 80px;">
        <div class="container">
            <div class="row g-5 mb-4">

                <div class="col-md-6 col-lg-3">
                    <div class="plus-all">
        <a href="{% url 'add_folder' %}" class="plus" id="create-category-btn" data-auth="{% if user.username %}true{% else %}false{% endif %}">
            <img src="{% static 'img/plus.svg' %}" title="Создать" alt="Создать папку">
        </a>
        <div class="text-plus ">Создать папку</div>
    </div>
                </div>
                {% for cat in category %}
                <div class="col-md-6 col-lg-3">
                   <div class="folder-all">
                    <img src="{% static 'img/folder.svg' %}" alt="folder" class="folder-icon" data-cat-slug="{{ cat.slug }}">
                    <div class="text-folder" data-cat-id="{{ cat.id }}">{{ cat.name }}</div>
                </div>

                </div>
                

                {% if forloop.counter == 3 %}
                    </div>
                    <div class="row g-5 mb-4" >
                {% endif %}

                {% if forloop.counter > 3 and forloop.counter|add:1|divisibleby:4  %}
                    </div>
                    <div class="row g-5 mb-4" >
                {% endif %}
            {% endfor %}
            </div>
        </div>
    </section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Перенаправление по двойному клику на иконку
    document.querySelectorAll('.folder-icon').forEach(icon => {
        icon.addEventListener('dblclick', () => {
            const slug = icon.dataset.catSlug;
            console.log(slug)
            window.location.href = `/folder/${slug}`;
            // Или если используете reverse URL, сформируйте URL динамически
        });
    });
    document.getElementById('create-category-btn').addEventListener('click', function(event) {
        event.preventDefault();
        const isAuth = this.dataset.auth === 'true'; // если используете data-атрибут

    if (!isAuth) {
        // Перенаправление на страницу логина, используйте URL из Django URL-имени
        window.location.href = "{% url 'users:login' %}";
        return;
    }
        fetch('/add_folder/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') // если у вас стоит CSRF защита
        },
        body: 'name=Noname'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Ошибка: ' + data.error);
        } else {
            alert('Папка "' + data.name + '" успешно создана');
            
            // Здесь можно обновить список категорий на странице без перезагрузки
        }
    });
    location.reload()
});


    // Редактирование имени по одиночному клику
    document.querySelectorAll('.text-folder').forEach(el => {
        el.addEventListener('click', () => {
            if (el.querySelector('input')) return; // Уже редактируется

            const catId = el.dataset.catId;
            console.log(catId)
            const oldName = el.textContent.trim();

            // Создаем input для редактирования
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.classList.add('edit-input');
            el.textContent = '';
            el.appendChild(input);
            input.focus();

            const save = () => {
                const newName = input.value.trim();
                if (newName && newName !== oldName) {
                    fetch(`/folder/${catId}/edit/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({ name: newName }),
                    })
                    .then(response => {
                        if (response.ok) el.textContent = newName;
                        else {
                            alert('Ошибка при обновлении!');
                            el.textContent = oldName;
                        const folderIcon = document.querySelector(`.folder-icon[data-cat-id="${catId}"]`);
                        }
                    })
                      location.reload()
                    .catch(() => {
                        alert('Ошибка связи с сервером!');
                        el.textContent = oldName;
                    });
                } else {
                    el.textContent = oldName;
                }
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') el.textContent = oldName;
            });
        });
    });
});

// Функция получения CSRF токена — оставьте без изменений
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


</script>



    </section>


</body>

</html>